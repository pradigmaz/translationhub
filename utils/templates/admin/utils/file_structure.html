{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block extrahead %}
<style>
.file-tree {
    font-family: monospace;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    max-height: 600px;
    overflow-y: auto;
}

.tree-node {
    margin: 2px 0;
    cursor: pointer;
}

.tree-node.directory {
    font-weight: bold;
    color: #0066cc;
}

.tree-node.file {
    color: #333;
}

.tree-indent {
    display: inline-block;
    width: 20px;
}

.tree-icon {
    margin-right: 5px;
}

.file-size {
    color: #666;
    font-size: 0.9em;
    margin-left: 10px;
}

.structure-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.stat-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #0066cc;
}

.missing-dirs {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
}

.missing-dirs h4 {
    color: #856404;
    margin-top: 0;
}

.missing-dirs ul {
    margin: 0;
    padding-left: 20px;
}

.missing-dirs li {
    color: #856404;
    margin: 5px 0;
}

.actions {
    margin: 20px 0;
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    margin: 5px;
    background: #007cba;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    border: none;
    cursor: pointer;
}

.btn:hover {
    background: #005a87;
    color: white;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #545b62;
}
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>{{ title }}</h1>
    
    {% if error %}
        <div class="alert alert-danger">
            <strong>–û—à–∏–±–∫–∞:</strong> {{ error }}
        </div>
    {% else %}
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã -->
        {% if structure_stats %}
        <div class="structure-stats">
            <div class="stat-card">
                <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div class="stat-number">{{ structure_stats.total_users }}</div>
                <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                <p><strong>{{ structure_stats.users_with_files }}</strong> —Å —Ñ–∞–π–ª–∞–º–∏</p>
                {% if structure_stats.missing_user_dirs %}
                    <p style="color: #dc3545;"><strong>{{ structure_stats.missing_user_dirs|length }}</strong> –±–µ–∑ –ø–∞–ø–æ–∫</p>
                {% endif %}
            </div>
            
            <div class="stat-card">
                <h3>–ö–æ–º–∞–Ω–¥—ã</h3>
                <div class="stat-number">{{ structure_stats.total_teams }}</div>
                <p>–í—Å–µ–≥–æ –∫–æ–º–∞–Ω–¥</p>
                <p><strong>{{ structure_stats.teams_with_files }}</strong> —Å —Ñ–∞–π–ª–∞–º–∏</p>
                {% if structure_stats.missing_team_dirs %}
                    <p style="color: #dc3545;"><strong>{{ structure_stats.missing_team_dirs|length }}</strong> –±–µ–∑ –ø–∞–ø–æ–∫</p>
                {% endif %}
            </div>
            
            <div class="stat-card">
                <h3>–ü—Ä–æ–µ–∫—Ç—ã</h3>
                <div class="stat-number">{{ structure_stats.total_projects }}</div>
                <p>–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                <p><strong>{{ structure_stats.projects_with_files }}</strong> —Å —Ñ–∞–π–ª–∞–º–∏</p>
                {% if structure_stats.missing_project_dirs %}
                    <p style="color: #dc3545;"><strong>{{ structure_stats.missing_project_dirs|length }}</strong> –±–µ–∑ –ø–∞–ø–æ–∫</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞–ø–∫–∞—Ö -->
        {% if structure_stats.missing_user_dirs %}
        <div class="missing-dirs">
            <h4>‚ö† –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
            <ul>
                {% for missing in structure_stats.missing_user_dirs|slice:":10" %}
                    <li>{{ missing.username }} (ID: {{ missing.id }}) - {{ missing.path }}</li>
                {% endfor %}
                {% if structure_stats.missing_user_dirs|length > 10 %}
                    <li>... –∏ –µ—â–µ {{ structure_stats.missing_user_dirs|length|add:"-10" }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
        
        {% if structure_stats.missing_team_dirs %}
        <div class="missing-dirs">
            <h4>‚ö† –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–ø–∫–∏ –∫–æ–º–∞–Ω–¥</h4>
            <ul>
                {% for missing in structure_stats.missing_team_dirs|slice:":10" %}
                    <li>{{ missing.name }} (ID: {{ missing.id }}) - {{ missing.path }}</li>
                {% endfor %}
                {% if structure_stats.missing_team_dirs|length > 10 %}
                    <li>... –∏ –µ—â–µ {{ structure_stats.missing_team_dirs|length|add:"-10" }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
        
        {% if structure_stats.missing_project_dirs %}
        <div class="missing-dirs">
            <h4>‚ö† –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤</h4>
            <ul>
                {% for missing in structure_stats.missing_project_dirs|slice:":10" %}
                    <li>{{ missing.title }} ({{ missing.team }}) - {{ missing.path }}</li>
                {% endfor %}
                {% if structure_stats.missing_project_dirs|length > 10 %}
                    <li>... –∏ –µ—â–µ {{ structure_stats.missing_project_dirs|length|add:"-10" }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
        
        <!-- –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ -->
        <div class="module">
            <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤</h2>
            <div class="file-tree" id="file-tree">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤...</div>
            </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="actions">
            <a href="{% url 'admin:file_statistics' %}" class="btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤</a>
            <a href="{% url 'admin:file_diagnostics' %}" class="btn">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</a>
            <a href="{% url 'admin:file_management' %}" class="btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏</a>
            <button onclick="refreshFileTree()" class="btn btn-secondary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    {% endif %}
</div>

<script>
let fileTreeData = {{ file_tree_json|safe }};

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderFileTree(node, level = 0) {
    if (node.error) {
        return `<div class="tree-node error" style="margin-left: ${level * 20}px;">
            <span class="tree-icon">‚ùå</span>
            –û—à–∏–±–∫–∞: ${node.error}
        </div>`;
    }
    
    let html = '';
    const indent = level * 20;
    
    if (node.is_dir) {
        const icon = node.children && node.children.length > 0 ? 'üìÅ' : 'üìÇ';
        const fileInfo = node.file_count !== undefined ? 
            ` (${node.file_count} —Ñ–∞–π–ª–æ–≤, ${node.dir_count} –ø–∞–ø–æ–∫)` : '';
        
        html += `<div class="tree-node directory" style="margin-left: ${indent}px;" onclick="toggleNode(this)">
            <span class="tree-icon">${icon}</span>
            ${node.name}
            <span class="file-size">${formatFileSize(node.size)}${fileInfo}</span>
        </div>`;
        
        if (node.children) {
            html += `<div class="tree-children">`;
            for (const child of node.children) {
                html += renderFileTree(child, level + 1);
            }
            html += `</div>`;
        }
    } else {
        const modifiedDate = node.modified ? new Date(node.modified).toLocaleString() : '';
        html += `<div class="tree-node file" style="margin-left: ${indent}px;">
            <span class="tree-icon">üìÑ</span>
            ${node.name}
            <span class="file-size">${formatFileSize(node.size)} - ${modifiedDate}</span>
        </div>`;
    }
    
    return html;
}

function toggleNode(element) {
    const children = element.nextElementSibling;
    if (children && children.classList.contains('tree-children')) {
        if (children.style.display === 'none') {
            children.style.display = 'block';
            element.querySelector('.tree-icon').textContent = 'üìÅ';
        } else {
            children.style.display = 'none';
            element.querySelector('.tree-icon').textContent = 'üìÇ';
        }
    }
}

function refreshFileTree() {
    const treeContainer = document.getElementById('file-tree');
    treeContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤...</div>';
    
    fetch('{% url "admin:api_file_tree" %}')
        .then(response => response.json())
        .then(data => {
            fileTreeData = data;
            treeContainer.innerHTML = renderFileTree(data);
        })
        .catch(error => {
            treeContainer.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error}</div>`;
        });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const treeContainer = document.getElementById('file-tree');
    treeContainer.innerHTML = renderFileTree(fileTreeData);
});
</script>
{% endblock %}
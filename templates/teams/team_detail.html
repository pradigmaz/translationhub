{% extends "base.html" %}

{% block title %}{{ team.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Индикатор статуса команды с улучшенным Bootstrap 5.3 дизайном -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header d-flex justify-content-between align-items-center
                    {% if team.status == 'active' %}text-bg-success{% elif team.status == 'inactive' %}text-bg-warning{% else %}text-bg-danger{% endif %} 
                    border-0 rounded-top">
                    <h1 class="card-title h3 mb-0 fw-bold">
                        <i class="fas fa-users me-2"></i>{{ team.name }}
                    </h1>
                    <span class="badge rounded-pill text-bg-light fs-6 px-3 py-2 shadow-sm">
                        <i class="fas 
                            {% if team.status == 'active' %}fa-check-circle text-success
                            {% elif team.status == 'inactive' %}fa-pause-circle text-warning
                            {% else %}fa-times-circle text-danger{% endif %} me-1"></i>
                        {{ team_status_display }}
                    </span>
                </div>
                
                {% if team.status != 'active' %}
                <div class="card-body p-0">
                    {% if team.status == 'inactive' %}
                        <div class="alert alert-warning alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fs-4 me-3"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Команда приостановлена</h6>
                                    <p class="mb-0">Функции управления ограничены. Только руководитель может возобновить работу команды.</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                        </div>
                    {% elif team.status == 'disbanded' %}
                        <div class="alert alert-danger alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-times-circle fs-4 me-3"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Команда распущена</h6>
                                    <p class="mb-0">Команда была окончательно распущена. Все участники исключены.</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Управление статусом команды с улучшенными Bootstrap 5.3 компонентами -->
    {% if can_manage_team and can_manage_team_permission and team.status != 'disbanded' %}
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header text-bg-primary border-0 rounded-top">
            <h3 class="card-title h5 mb-0 fw-bold">
                <i class="fas fa-cogs me-2"></i>Управление командой
            </h3>
        </div>
        <div class="card-body p-4">
            <form method="post" action="{% url 'teams:team_status_change' team.pk %}" 
                  onsubmit="return confirmStatusChange(event)">
                {% csrf_token %}
                
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="mb-3">
                            <label for="reason" class="form-label fw-semibold">
                                <i class="fas fa-comment-alt me-1 text-muted"></i>
                                Причина изменения (необязательно):
                            </label>
                            <textarea name="reason" id="reason" class="form-control form-control-lg" rows="3" 
                                      placeholder="Укажите причину изменения статуса команды..."
                                      style="resize: vertical;"></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Причина будет сохранена в истории изменений команды
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-tools me-1 text-muted"></i>
                            Доступные действия:
                        </label>
                        <div class="d-grid gap-3">
                            {% if can_deactivate %}
                                <button type="submit" name="action" value="deactivate" 
                                        class="btn btn-warning btn-lg shadow-sm" 
                                        data-bs-toggle="tooltip" 
                                        title="Временно приостановить работу команды">
                                    <i class="fas fa-pause me-2"></i>Приостановить команду
                                </button>
                            {% endif %}
                            
                            {% if can_reactivate %}
                                <button type="submit" name="action" value="reactivate" 
                                        class="btn btn-success btn-lg shadow-sm"
                                        data-bs-toggle="tooltip" 
                                        title="Возобновить работу команды">
                                    <i class="fas fa-play me-2"></i>Возобновить команду
                                </button>
                            {% endif %}
                            
                            {% if can_disband %}
                                <button type="submit" name="action" value="disband" 
                                        class="btn btn-danger btn-lg shadow-sm"
                                        data-bs-toggle="tooltip" 
                                        title="Окончательно распустить команду">
                                    <i class="fas fa-times me-2"></i>Распустить команду
                                </button>
                            {% endif %}
                        </div>
                        
                        <!-- Информационные карточки о действиях -->
                        <div class="mt-3">
                            {% if can_deactivate %}
                                <div class="alert alert-warning alert-sm py-2 px-3 mb-2" role="alert">
                                    <small><i class="fas fa-info-circle me-1"></i>Приостановка временная, команду можно будет возобновить</small>
                                </div>
                            {% endif %}
                            {% if can_disband %}
                                <div class="alert alert-danger alert-sm py-2 px-3 mb-0" role="alert">
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>Роспуск команды необратим!</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap 5.3 модальные окна для подтверждения -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="confirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Подтверждение действия
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="alert alert-light border-start border-4 border-warning" role="alert">
                        <p id="confirmMessage" class="mb-0"></p>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Отмена
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmAction">
                        <i class="fas fa-check me-1"></i>Подтвердить
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Bootstrap 5.3 модальное окно для результата -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0" id="resultModalHeader">
                    <h5 class="modal-title fw-bold" id="resultModalLabel">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Операция выполнена
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="alert alert-success border-0" role="alert" id="resultMessage">
                        Статус команды успешно изменен
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>Понятно
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Улучшенная система подтверждения с Bootstrap 5.3 модальными окнами и AJAX
    function confirmStatusChange(event) {
        event.preventDefault();
        
        const action = event.submitter.value;
        const form = event.target;
        let message = '';
        let modalClass = 'btn-primary';
        let iconClass = 'fa-check';
        
        switch(action) {
            case 'deactivate':
                message = 'Вы уверены, что хотите приостановить команду? Участники не смогут работать с проектами до возобновления работы команды.';
                modalClass = 'btn-warning';
                iconClass = 'fa-pause';
                break;
            case 'reactivate':
                message = 'Вы уверены, что хотите возобновить работу команды? Все участники снова получат доступ к функциям команды.';
                modalClass = 'btn-success';
                iconClass = 'fa-play';
                break;
            case 'disband':
                message = 'ВНИМАНИЕ! Вы собираетесь окончательно распустить команду. Это действие необратимо!\n\nВсе участники будут исключены из команды, и восстановить её будет невозможно. Вы действительно хотите продолжить?';
                modalClass = 'btn-danger';
                iconClass = 'fa-times';
                break;
        }
        
        document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
        const confirmButton = document.getElementById('confirmAction');
        confirmButton.className = `btn ${modalClass}`;
        confirmButton.innerHTML = `<i class="fas ${iconClass} me-1"></i>Подтвердить`;
        
        confirmButton.onclick = function() {
            const confirmModalElement = document.getElementById('confirmModal');
            const confirmModalInstance = bootstrap.Modal.getInstance(confirmModalElement);
            if (confirmModalInstance) {
                confirmModalInstance.hide();
            }
            
            // Выполняем AJAX запрос сразу без модального окна загрузки
            performStatusChange(form, action);
        };
        
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
        
        return false;
    }
    
    // AJAX функция для изменения статуса команды
    function performStatusChange(form, action) {
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Принудительно закрываем все модальные окна загрузки
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal.id.includes('loading') || modal.id.includes('Loading')) {
                    const instance = bootstrap.Modal.getInstance(modal);
                    if (instance) {
                        instance.dispose();
                    }
                    modal.remove();
                }
            });
            
            // Очищаем все backdrop'ы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            if (data.success) {
                // Обновляем интерфейс
                updateTeamStatusUI(data.team_status, data.team_status_display, action);
                
                // Показываем модальное окно с результатом
                showResultModal(data.message, 'success');
                
                // Обновляем историю изменений
                if (data.status_history_html) {
                    updateStatusHistory(data.status_history_html);
                }
                
                // Обновляем счетчики в навигации
                if (window.updateNavigationCounters) {
                    window.updateNavigationCounters();
                }
            } else {
                showResultModal(data.message || 'Произошла ошибка при изменении статуса', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Принудительно закрываем все модальные окна загрузки при ошибке
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal.id.includes('loading') || modal.id.includes('Loading')) {
                    const instance = bootstrap.Modal.getInstance(modal);
                    if (instance) {
                        instance.dispose();
                    }
                    modal.remove();
                }
            });
            
            // Очищаем все backdrop'ы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            showResultModal('Произошла ошибка при выполнении запроса. Попробуйте еще раз.', 'error');
        });
    }
    
    // Функция для обновления интерфейса статуса команды
    function updateTeamStatusUI(status, statusDisplay, action) {
        // Обновляем заголовок команды
        const headerElement = document.querySelector('.card-header');
        if (headerElement) {
            // Удаляем старые классы статуса
            headerElement.classList.remove('text-bg-success', 'text-bg-warning', 'text-bg-danger');
            
            // Добавляем новый класс статуса
            if (status === 'active') {
                headerElement.classList.add('text-bg-success');
            } else if (status === 'inactive') {
                headerElement.classList.add('text-bg-warning');
            } else {
                headerElement.classList.add('text-bg-danger');
            }
        }
        
        // Обновляем бейдж статуса
        const statusBadge = document.querySelector('.badge.rounded-pill.text-bg-light');
        if (statusBadge) {
            const iconElement = statusBadge.querySelector('i');
            if (iconElement) {
                iconElement.className = 'fas me-1 ' + getStatusIcon(status);
            }
            statusBadge.lastChild.textContent = ' ' + statusDisplay;
        }
        
        // Обновляем алерты статуса
        updateStatusAlerts(status);
        
        // Обновляем кнопки управления
        updateManagementButtons(status);
        
        // Добавляем анимацию обновления
        animateStatusUpdate();
    }
    
    // Функция для получения иконки статуса
    function getStatusIcon(status) {
        switch(status) {
            case 'active':
                return 'fa-check-circle text-success';
            case 'inactive':
                return 'fa-pause-circle text-warning';
            case 'disbanded':
                return 'fa-times-circle text-danger';
            default:
                return 'fa-question-circle';
        }
    }
    
    // Функция для обновления алертов статуса
    function updateStatusAlerts(status) {
        const alertContainer = document.querySelector('.card-body .alert');
        const cardBody = document.querySelector('.card .card-body');
        
        if (status === 'active') {
            // Удаляем алерт для активной команды
            if (alertContainer) {
                alertContainer.remove();
            }
            // Удаляем card-body если он пустой
            if (cardBody && !cardBody.innerHTML.trim()) {
                cardBody.remove();
            }
        } else {
            // Создаем или обновляем алерт
            let alertHTML = '';
            if (status === 'inactive') {
                alertHTML = `
                    <div class="alert alert-warning alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fs-4 me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Команда приостановлена</h6>
                                <p class="mb-0">Функции управления ограничены. Только руководитель может возобновить работу команды.</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                    </div>
                `;
            } else if (status === 'disbanded') {
                alertHTML = `
                    <div class="alert alert-danger alert-dismissible fade show mb-0 rounded-0 border-0" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-times-circle fs-4 me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Команда распущена</h6>
                                <p class="mb-0">Команда была окончательно распущена. Все участники исключены.</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                    </div>
                `;
            }
            
            if (alertHTML) {
                if (alertContainer) {
                    alertContainer.outerHTML = alertHTML;
                } else {
                    // Создаем card-body если его нет
                    if (!cardBody) {
                        const cardElement = document.querySelector('.card');
                        const newCardBody = document.createElement('div');
                        newCardBody.className = 'card-body p-0';
                        newCardBody.innerHTML = alertHTML;
                        cardElement.appendChild(newCardBody);
                    } else {
                        cardBody.innerHTML = alertHTML;
                    }
                }
            }
        }
    }
    
    // Функция для обновления кнопок управления
    function updateManagementButtons(status) {
        const deactivateBtn = document.querySelector('button[value="deactivate"]');
        const reactivateBtn = document.querySelector('button[value="reactivate"]');
        const disbandBtn = document.querySelector('button[value="disband"]');
        
        // Скрываем все кнопки
        if (deactivateBtn) deactivateBtn.style.display = 'none';
        if (reactivateBtn) reactivateBtn.style.display = 'none';
        if (disbandBtn) disbandBtn.style.display = 'none';
        
        // Показываем нужные кнопки
        if (status === 'active') {
            if (deactivateBtn) deactivateBtn.style.display = 'block';
            if (disbandBtn) disbandBtn.style.display = 'block';
        } else if (status === 'inactive') {
            if (reactivateBtn) reactivateBtn.style.display = 'block';
            if (disbandBtn) disbandBtn.style.display = 'block';
        }
        // Для disbanded статуса все кнопки остаются скрытыми
    }
    
    // Функция для показа модального окна с результатом
    function showResultModal(message, type) {
        const modal = document.getElementById('resultModal');
        const header = document.getElementById('resultModalHeader');
        const title = document.getElementById('resultModalLabel');
        const messageElement = document.getElementById('resultMessage');
        
        // Настраиваем внешний вид в зависимости от типа
        if (type === 'success') {
            title.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Операция выполнена';
            messageElement.className = 'alert alert-success border-0';
        } else {
            title.innerHTML = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>Ошибка';
            messageElement.className = 'alert alert-danger border-0';
        }
        
        messageElement.textContent = message;
        
        const resultModal = new bootstrap.Modal(modal);
        resultModal.show();
    }
    
    // Функция для обновления истории изменений
    function updateStatusHistory(historyHTML) {
        const historyContainer = document.querySelector('.card .list-group');
        if (historyContainer && historyHTML) {
            historyContainer.innerHTML = historyHTML;
        }
    }
    
    // Функция для анимации обновления статуса
    function animateStatusUpdate() {
        const statusCard = document.querySelector('.card');
        if (statusCard) {
            statusCard.style.transform = 'scale(0.98)';
            statusCard.style.transition = 'transform 0.2s ease-in-out';
            
            setTimeout(() => {
                statusCard.style.transform = 'scale(1)';
                setTimeout(() => {
                    statusCard.style.transition = '';
                }, 200);
            }, 100);
        }
    }
    
    // Инициализация Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    </script>
    {% endif %}

    <!-- История изменений статуса с улучшенным Bootstrap 5.3 дизайном -->
    {% if recent_status_changes %}
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header text-bg-info border-0 rounded-top">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title h5 mb-0 fw-bold">
                    <i class="fas fa-history me-2"></i>Последние изменения
                </h3>
                <span class="badge text-bg-light rounded-pill px-3 py-2">
                    <i class="fas fa-clock me-1"></i>{{ recent_status_changes|length }} записей
                </span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                {% for change in recent_status_changes %}
                <div class="list-group-item border-0 py-3 px-4 d-flex justify-content-between align-items-start">
                    <div class="me-auto">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge rounded-pill me-3 px-3 py-2
                                {% if change.change_type == 'created' %}text-bg-success
                                {% elif change.change_type == 'deactivated' %}text-bg-warning
                                {% elif change.change_type == 'reactivated' %}text-bg-info
                                {% else %}text-bg-danger{% endif %}">
                                <i class="fas 
                                    {% if change.change_type == 'created' %}fa-plus
                                    {% elif change.change_type == 'deactivated' %}fa-pause
                                    {% elif change.change_type == 'reactivated' %}fa-play
                                    {% else %}fa-times{% endif %} me-1"></i>
                                {{ change.get_change_type_display }}
                            </span>
                            <div class="fw-bold text-dark">{{ change.get_change_type_display }}</div>
                        </div>
                        
                        <div class="d-flex align-items-center text-body-secondary mb-1">
                            <i class="fas fa-user me-2"></i>
                            <span class="me-3">
                                {% if change.changed_by %}
                                    {{ change.changed_by.username }}
                                {% else %}
                                    Система
                                {% endif %}
                            </span>
                            <i class="fas fa-calendar-alt me-2"></i>
                            <span>{{ change.timestamp|date:"d.m.Y H:i" }}</span>
                        </div>
                        
                        {% if change.reason %}
                            <div class="mt-2 p-2 bg-light rounded border-start border-3 border-info">
                                <small class="text-muted">
                                    <i class="fas fa-quote-left me-1"></i>
                                    <em>{{ change.reason }}</em>
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% if not forloop.last %}
                    <hr class="my-0 mx-4 text-muted opacity-25">
                {% endif %}
                {% endfor %}
            </div>
            
            <div class="card-footer bg-light border-0 rounded-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Показаны последние {{ recent_status_changes|length }} изменений
                    </small>
                    <a href="{% url 'teams:team_status_history' team.pk %}" 
                       class="btn btn-sm btn-outline-info shadow-sm">
                        <i class="fas fa-list me-1"></i>Полная история
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Раздел участников команды с улучшенным Bootstrap 5.3 дизайном -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header text-bg-info border-0 rounded-top d-flex justify-content-between align-items-center">
                    <h3 class="card-title h5 mb-0 fw-bold">
                        <i class="fas fa-users me-2"></i>Участники команды
                    </h3>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge text-bg-light rounded-pill px-3 py-2">
                            <i class="fas fa-user-friends me-1"></i>{{ memberships|length }} участников
                        </span>
                        {% if team.status != 'active' %}
                            <span class="badge text-bg-warning rounded-pill px-3 py-2">
                                {% if team.status == 'inactive' %}
                                    <i class="fas fa-eye me-1"></i>Все участники
                                {% else %}
                                    <i class="fas fa-history me-1"></i>Бывшие участники
                                {% endif %}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if memberships %}
                        <div class="row g-4">
                            {% for membership in memberships %}
                                <div class="col-lg-6">
                                    <div class="card h-100 border-0 bg-light {% if not membership.is_active %}opacity-75{% endif %} shadow-sm">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <!-- Аватар участника -->
                                                <div class="position-relative me-3">
                                                    {% if membership.user.avatar %}
                                                        <img src="{{ membership.user.avatar.url }}" 
                                                             class="rounded-circle shadow border border-2 border-white" 
                                                             width="60" height="60" 
                                                             alt="Аватар {{ membership.user.username }}"
                                                             style="object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center shadow border border-2 border-white" 
                                                             style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                            <i class="fas fa-user text-white fs-4"></i>
                                                        </div>
                                                    {% endif %}
                                                    
                                                    <!-- Индикатор статуса -->
                                                    {% if membership.is_active %}
                                                        <span class="position-absolute bottom-0 end-0 badge rounded-pill text-bg-success border border-2 border-white">
                                                            <i class="fas fa-check"></i>
                                                        </span>
                                                    {% else %}
                                                        <span class="position-absolute bottom-0 end-0 badge rounded-pill text-bg-secondary border border-2 border-white">
                                                            <i class="fas fa-pause"></i>
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Информация об участнике -->
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <h6 class="mb-0 fw-bold text-dark me-2">
                                                            {{ membership.user.display_name|default:membership.user.username }}
                                                        </h6>
                                                        {% if membership.user == team.creator %}
                                                            <span class="badge text-bg-warning rounded-pill px-2 py-1" 
                                                                  data-bs-toggle="tooltip" title="Создатель команды">
                                                                <i class="fas fa-crown"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- Роли участника -->
                                                    <div class="d-flex flex-wrap gap-1 mb-2">
                                                        {% if membership.roles.exists %}
                                                            {% for role in membership.roles.all %}
                                                                <span class="badge text-bg-primary rounded-pill px-2 py-1">
                                                                    <i class="fas fa-tag me-1"></i>{{ role.name }}
                                                                </span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="badge text-bg-light text-dark rounded-pill px-2 py-1">
                                                                <i class="fas fa-user me-1"></i>Без роли
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- Дополнительная информация -->
                                                    <div class="d-flex align-items-center text-muted small">
                                                        <i class="fas fa-calendar-plus me-1"></i>
                                                        <span>{{ membership.joined_at|date:"d.m.Y" }}</span>
                                                        {% if not membership.is_active %}
                                                            <span class="mx-2">•</span>
                                                            <span class="badge text-bg-secondary rounded-pill px-2 py-1">
                                                                Неактивен
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                <!-- Кнопки управления участником -->
                                                {% if membership.user != team.creator %}
                                                    <div class="ms-2">
                                                        <div class="dropdown">
                                                            {% if can_remove_members or can_assign_roles %}
                                                                <button class="btn btn-outline-secondary btn-sm" 
                                                                        type="button" 
                                                                        disabled
                                                                        data-bs-toggle="tooltip" 
                                                                        title="Функция будет доступна в следующих версиях">
                                                                    <i class="fas fa-ellipsis-v"></i>
                                                                </button>
                                                            {% else %}
                                                                <button class="btn btn-outline-secondary btn-sm" 
                                                                        type="button" 
                                                                        disabled
                                                                        data-bs-toggle="tooltip" 
                                                                        title="У вас нет прав для управления участниками">
                                                                    <i class="fas fa-lock"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Информация о разрешениях пользователя -->
                        {% if user_membership and user_permissions %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-primary mb-3">
                                            <i class="fas fa-shield-alt me-2"></i>
                                            Ваши разрешения в команде
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_manage_team_permission %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Управление командой</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Управление командой</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_invite_members %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Приглашение участников</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Приглашение участников</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_assign_roles %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Назначение ролей</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Назначение ролей</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_create_project %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Создание проектов</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Создание проектов</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_manage_project %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Управление проектами</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Управление проектами</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    {% if can_remove_members %}
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        <span class="text-success">Удаление участников</span>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-muted me-2"></i>
                                                        <span class="text-muted">Удаление участников</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Разрешения определяются вашими ролями в команде
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Дополнительная информация о команде -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info border-0 bg-light" role="alert">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-info-circle fs-4 me-3 text-info"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Информация о команде</h6>
                                            <p class="mb-0">
                                                Команда создана {{ team.created_at|date:"d.m.Y" }}. 
                                                {% if team.status == 'active' %}
                                                    Все участники имеют доступ к функциям команды.
                                                {% elif team.status == 'inactive' %}
                                                    Команда приостановлена, функции ограничены.
                                                {% else %}
                                                    Команда распущена, участники исключены.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-users text-muted opacity-25" style="font-size: 4rem;"></i>
                            </div>
                            <h5 class="text-muted mb-3">В команде пока нет участников</h5>
                            <p class="text-muted mb-4">Пригласите коллег для совместной работы над проектами</p>
                            {% if can_invite_members %}
                                <button class="btn btn-outline-primary btn-lg" disabled>
                                    <i class="fas fa-user-plus me-2"></i>Пригласить участников
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Функция приглашения будет доступна в следующих версиях
                                    </small>
                                </div>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-lg" disabled 
                                        data-bs-toggle="tooltip" 
                                        title="У вас нет разрешения на приглашение участников">
                                    <i class="fas fa-lock me-2"></i>Пригласить участников
                                </button>
                                <div class="mt-2">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Недостаточно прав для приглашения участников
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



    <!-- Раздел проектов команды с улучшенным Bootstrap 5.3 дизайном -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header text-bg-primary border-0 rounded-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="card-title h5 mb-0 fw-bold">
                            <i class="fas fa-project-diagram me-2"></i>Проекты команды
                        </h2>
                        <span class="badge text-bg-light rounded-pill px-3 py-2">
                            <i class="fas fa-folder me-1"></i>
                            {% if projects %}{{ projects|length }}{% else %}0{% endif %} проектов
                        </span>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if projects %}
                        <div class="row g-3">
                            {% for project in projects %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 border-0 bg-light shadow-sm" 
                                         style="transition: all 0.15s ease-in-out;"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0.5rem 1rem rgba(0, 0, 0, 0.15)'"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0.125rem 0.25rem rgba(0, 0, 0, 0.075)'">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0 fw-bold text-truncate me-2">
                                                    <a href="{% url 'projects:project_detail' project.id %}" 
                                                       class="text-decoration-none text-dark">
                                                        {{ project.title }}
                                                    </a>
                                                </h6>
                                                <span class="{{ project.get_status_badge_class }} rounded-pill px-2 py-1 flex-shrink-0">
                                                    <i class="{{ project.get_status_icon }} me-1"></i>{{ project.get_status_display }}
                                                </span>
                                            </div>
                                            {% if project.description %}
                                                <p class="card-text text-muted small mb-2">
                                                    {{ project.description|truncatechars:80 }}
                                                </p>
                                            {% endif %}
                                            <p class="card-text text-muted small mb-2">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Создан: {{ project.created_at|date:"d.m.Y" }}
                                            </p>
                                            <p class="card-text text-muted small mb-3">
                                                <i class="fas fa-folder me-1"></i>
                                                Папка: {{ project.content_folder }}
                                            </p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="fas fa-book me-1"></i>
                                                    {{ project.chapters.count }} глав
                                                </small>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'projects:project_detail' project.id %}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i>Подробнее
                                                    </a>
                                                    <a href="{% url 'projects:edit_project' project.id %}" 
                                                       class="btn btn-sm btn-outline-secondary">
                                                        <i class="fas fa-edit me-1"></i>Редактировать
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-between align-items-center">
                            <div class="alert alert-success border-start border-4 border-success flex-grow-1 me-3" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success fs-4 me-3"></i>
                                    <div>
                                        <h6 class="alert-heading mb-1">Управление проектами активно</h6>
                                        <p class="mb-0">
                                            Вы можете создавать и управлять проектами команды.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% if team.status == 'active' and user_membership and user_membership.is_active and can_create_project %}
                                <a href="{% url 'projects:create_project' %}?team={{ team.id }}" 
                                   class="btn btn-primary btn-lg shadow-sm">
                                    <i class="fas fa-plus me-2"></i>Создать проект
                                </a>
                            {% elif team.status == 'active' and user_membership and user_membership.is_active and not can_create_project %}
                                <button class="btn btn-outline-secondary btn-lg" disabled 
                                        data-bs-toggle="tooltip" 
                                        title="У вас нет разрешения на создание проектов в этой команде">
                                    <i class="fas fa-lock me-2"></i>Создать проект
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-project-diagram text-muted opacity-25" style="font-size: 4rem;"></i>
                            </div>
                            <h5 class="text-muted mb-3">У команды пока нет проектов</h5>
                            <p class="text-muted mb-4">Создайте первый проект для совместной работы</p>
                            {% if team.status == 'active' and user_membership and user_membership.is_active and can_create_project %}
                                <a href="{% url 'projects:create_project' %}?team={{ team.id }}" 
                                   class="btn btn-primary btn-lg shadow-sm">
                                    <i class="fas fa-plus me-2"></i>Создать проект
                                </a>
                                <div class="mt-3">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Функция создания проектов активна
                                    </small>
                                </div>
                            {% elif team.status == 'active' and user_membership and user_membership.is_active and not can_create_project %}
                                <button class="btn btn-outline-secondary btn-lg" disabled 
                                        data-bs-toggle="tooltip" 
                                        title="У вас нет разрешения на создание проектов в этой команде">
                                    <i class="fas fa-lock me-2"></i>Создать проект
                                </button>
                                <div class="mt-3">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Недостаточно прав для создания проектов
                                    </small>
                                </div>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-lg" disabled
                                    <i class="fas fa-plus me-2"></i>Создать проект
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% if team.status != 'active' %}
                                            Команда должна быть активной для создания проектов
                                        {% elif not user_membership or not user_membership.is_active %}
                                            Только активные участники команды могут создавать проекты
                                        {% endif %}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}